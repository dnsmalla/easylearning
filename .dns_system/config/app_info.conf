#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# DNS SYSTEM - APPLICATION CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# This file is auto-loaded by the DNS system. Configure your app details below.
# Run `bash .cursorrules init` to auto-detect values from your project.
# ═══════════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────────
# Application Identity
# ───────────────────────────────────────────────────────────────────────────────

# App name (auto-detected from project.yml, Package.swift, or directory name)
APP_NAME="${APP_NAME:-$(basename "$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)")}"

# Bundle identifier (for iOS/macOS apps)
APP_BUNDLE_ID="${APP_BUNDLE_ID:-com.example.${APP_NAME,,}}"

# ───────────────────────────────────────────────────────────────────────────────
# Version Information
# ───────────────────────────────────────────────────────────────────────────────

APP_VERSION="${APP_VERSION:-1.0.0}"
BUILD_NUMBER="${BUILD_NUMBER:-1}"

# ───────────────────────────────────────────────────────────────────────────────
# Contact & Support
# ───────────────────────────────────────────────────────────────────────────────

SUPPORT_EMAIL="${SUPPORT_EMAIL:-}"
SUPPORT_URL="${SUPPORT_URL:-}"
PRIVACY_URL="${PRIVACY_URL:-}"
TERMS_URL="${TERMS_URL:-}"

# ───────────────────────────────────────────────────────────────────────────────
# Developer Information
# ───────────────────────────────────────────────────────────────────────────────

DEVELOPER_NAME="${DEVELOPER_NAME:-}"
TEAM_ID="${TEAM_ID:-}"

# ───────────────────────────────────────────────────────────────────────────────
# Platform Configuration
# ───────────────────────────────────────────────────────────────────────────────

# Supported platforms: ios, macos, watchos, tvos, android, web, flutter
PLATFORMS="${PLATFORMS:-ios}"

# Minimum deployment targets
IOS_DEPLOYMENT_TARGET="${IOS_DEPLOYMENT_TARGET:-16.0}"
MACOS_DEPLOYMENT_TARGET="${MACOS_DEPLOYMENT_TARGET:-13.0}"

# ───────────────────────────────────────────────────────────────────────────────
# Build Configuration
# ───────────────────────────────────────────────────────────────────────────────

# Build schemes
DEBUG_SCHEME="${DEBUG_SCHEME:-Debug}"
RELEASE_SCHEME="${RELEASE_SCHEME:-Release}"

# Code signing (configured separately in exportOptions.plist)
CODE_SIGN_STYLE="${CODE_SIGN_STYLE:-Automatic}"

# ═══════════════════════════════════════════════════════════════════════════════
# AUTO-DETECTION FUNCTIONS (used by DNS system)
# ═══════════════════════════════════════════════════════════════════════════════

_dns_detect_app_name() {
    local project_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
    
    # Try project.yml first (XcodeGen)
    if [[ -f "$project_root/"*"/project.yml" ]]; then
        local name=$(grep -m1 "^name:" "$project_root/"*"/project.yml" 2>/dev/null | cut -d: -f2 | tr -d ' "')
        [[ -n "$name" ]] && echo "$name" && return
    fi
    
    # Try Package.swift (Swift Package)
    if [[ -f "$project_root/Package.swift" ]]; then
        local name=$(grep -m1 'name:' "$project_root/Package.swift" 2>/dev/null | sed 's/.*name:[[:space:]]*"\([^"]*\)".*/\1/')
        [[ -n "$name" ]] && echo "$name" && return
    fi
    
    # Try pubspec.yaml (Flutter)
    if [[ -f "$project_root/pubspec.yaml" ]]; then
        local name=$(grep -m1 "^name:" "$project_root/pubspec.yaml" 2>/dev/null | cut -d: -f2 | tr -d ' ')
        [[ -n "$name" ]] && echo "$name" && return
    fi
    
    # Try package.json (Node/React)
    if [[ -f "$project_root/package.json" ]]; then
        local name=$(grep -m1 '"name"' "$project_root/package.json" 2>/dev/null | sed 's/.*"name":[[:space:]]*"\([^"]*\)".*/\1/')
        [[ -n "$name" ]] && echo "$name" && return
    fi
    
    # Fallback to directory name
    basename "$project_root"
}

# Export detected name if not already set
if [[ -z "$APP_NAME" ]] || [[ "$APP_NAME" == "$(basename "$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)")" ]]; then
    APP_NAME="$(_dns_detect_app_name)"
fi

export APP_NAME APP_BUNDLE_ID APP_VERSION BUILD_NUMBER
export SUPPORT_EMAIL SUPPORT_URL PRIVACY_URL TERMS_URL
export DEVELOPER_NAME TEAM_ID PLATFORMS
export IOS_DEPLOYMENT_TARGET MACOS_DEPLOYMENT_TARGET
export DEBUG_SCHEME RELEASE_SCHEME CODE_SIGN_STYLE
